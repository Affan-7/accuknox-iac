trigger:
- main

pool:
  name: "self hosted"

variables:
- group: AccuKnox # Name of the variable group created in the Azure DevOps

steps:
- script: echo Building the app...
  displayName: 'Build'

- script: echo Testing the app...
  displayName: 'Test'

- script: |
    pip install checkov
    checkov -d . --output json > checkov_report.json || true
    jq --arg repoLink "https://github.com/$(Build.Repository.Name)" --arg branch "$(Build.SourceBranchName)" \
      '. += [{"details": {"repo": $repoLink, "branch": $branch}}]' checkov_report.json > result.json
    cat result.json
    curl --location --request POST "https://cspm.demo.accuknox.com/api/v1/artifact/?tenant_id=$(TENANT_ID)&data_type=IAC&save_to_s3=true&(LABEL)" \
      --header "Tenant-Id: $(TENANT_ID)" \
      --header "Authorization: Bearer $(AK_TOKEN)" \
      --form "file=@./result.json"
  displayName: 'IaC Scan'